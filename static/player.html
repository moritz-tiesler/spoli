<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Spotify Web Playback SDK Quick Start</title>
    <style>
        body {
            background-color: #333;
            color: #eee;
            font-family: monospace;
        }

        #ascii-output {
            white-space: pre;
            /* Preserves whitespace and line breaks */
            font-size: 0.75rem;
            /* Adjust as needed for density */
            line-height: 1;
            /* To make lines closer */
            /* Further styling to simulate a terminal */
            background-color: rgb(38, 36, 36);
            padding: 0.625rem;
            border-radius: 0.313rem;
            overflow: auto;
        }
    </style>
</head>

<body>
    <h1>Spotify Web Playback SDK Quick Start</h1>
    <button id="togglePlay">Toggle Play</button>
    <button id="nextTrack">Next Track</button>
    <div id="ascii-output">Loading...</div>

    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.2.0/ansi_up.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <script>


        window.onSpotifyWebPlaybackSDKReady = () => { };
        async function waitForSpotifyWebPlaybackSDKToLoad() {
            return new Promise(resolve => {
                if (window.Spotify) {
                    resolve(window.Spotify);
                } else {
                    window.onSpotifyWebPlaybackSDKReady = () => {
                        resolve(window.Spotify);
                    };
                }
            });
        };

        async function waitUntilUserHasSelectedPlayer(sdk) {
            return new Promise(resolve => {
                let interval = setInterval(async () => {
                    let state = await sdk.getCurrentState();
                    if (state !== null) {
                        resolve(state);
                        clearInterval(interval);
                    }
                });
            });
        };

        async function fetchToken() {
            const resp = await fetch('http://localhost:8080/tok', {
                method: "GET",
                // body: JSON.stringify({
                //     userId: 1,
                //     title: "Fix my bugs",
                //     completed: false
                // })
            })
            if (!resp.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const tok = await resp.text();
            return tok
        }

        (async () => {
            let token = await fetchToken()

            const { Player } = await waitForSpotifyWebPlaybackSDKToLoad();

            const sdk = new Player({
                name: 'Web Playback SDK Quick Start Player',
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });
            sdk.addListener('ready', ({ device_id }) => {
                fetch(`/id/${device_id}`, {
                    method: "POST"
                })
                console.log('Ready with Device ID', device_id);
                let div = document.createElement('div');
                div.id = "deviceId";
                div.innerHTML = `<span>${device_id}</span>`;
                document.body.appendChild(div);
            });

            sdk.on("player_state_changed", state => {
                // Update UI with playback state changes
            });

            let connected = await sdk.connect();

            if (connected) {
                let state = await waitUntilUserHasSelectedPlayer(sdk);

                // Not Ready
                sdk.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });
                sdk.addListener('initialization_error', ({ message }) => {
                    console.error(message);
                });

                sdk.addListener('authentication_error', ({ message }) => {
                    console.error(message);
                });

                sdk.addListener('account_error', ({ message }) => {
                    console.error(message);
                });

                document.getElementById('togglePlay').onclick = function () {
                    sdk.togglePlay();
                };
                document.getElementById('nextTrack').onclick = async function () {
                    sdk.nextTrack().then(() => {
                        console.log('Skipped to next track!');
                    });
                    const state = await sdk.getCurrentState()
                    console.log(state)
                    albumArtUrl = state.track_window.current_track.album.images[2].url
                    console.log(albumArtUrl)

                    resp = await fetch(`/art?url=${albumArtUrl}`, {
                        method: "POST"
                    });
                    rawAscii = await resp.text()

                    const asciiOutputDiv = document.getElementById('ascii-output')

                    // const plainAscii = art.replace(rawAscii, '');
                    // const ansiRegex = /[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g;
                    // asciiOutputDiv.textContent = plainAscii

                    const ansi_up = new AnsiUp();
                    asciiOutputDiv.innerHTML = ansi_up.ansi_to_html(rawAscii);
                };
            }
        })();

    </script>
</body>

</html>