<!DOCTYPE html>
<html>

<head>
    <title>Spotify Web Playback SDK Quick Start</title>
</head>

<body>
    <h1>Spotify Web Playback SDK Quick Start</h1>
    <button id="togglePlay">Toggle Play</button>
    <button id="nextTrack">Next Track</button>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <script>


        window.onSpotifyWebPlaybackSDKReady = () => { };
        async function waitForSpotifyWebPlaybackSDKToLoad() {
            return new Promise(resolve => {
                if (window.Spotify) {
                    resolve(window.Spotify);
                } else {
                    window.onSpotifyWebPlaybackSDKReady = () => {
                        resolve(window.Spotify);
                    };
                }
            });
        };

        async function waitUntilUserHasSelectedPlayer(sdk) {
            return new Promise(resolve => {
                let interval = setInterval(async () => {
                    let state = await sdk.getCurrentState();
                    if (state !== null) {
                        resolve(state);
                        clearInterval(interval);
                    }
                });
            });
        };

        async function fetchToken() {
            const resp = await fetch('http://localhost:8080/tok', {
                method: "GET",
                // body: JSON.stringify({
                //     userId: 1,
                //     title: "Fix my bugs",
                //     completed: false
                // })
            })
            if (!resp.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const tok = await resp.text();
            return tok
        }

        (async () => {
            let token = await fetchToken()

            const { Player } = await waitForSpotifyWebPlaybackSDKToLoad();

            const sdk = new Player({
                name: 'Web Playback SDK Quick Start Player',
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });
            sdk.addListener('ready', ({ device_id }) => {
                fetch(`/id/${device_id}`, {
                    method: "POST"
                })
                console.log('Ready with Device ID', device_id);
            });

            sdk.on("player_state_changed", state => {
                // Update UI with playback state changes
            });

            let connected = await sdk.connect();

            if (connected) {
                let state = await waitUntilUserHasSelectedPlayer(sdk);

                // Not Ready
                sdk.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });
                sdk.addListener('initialization_error', ({ message }) => {
                    console.error(message);
                });

                sdk.addListener('authentication_error', ({ message }) => {
                    console.error(message);
                });

                sdk.addListener('account_error', ({ message }) => {
                    console.error(message);
                });

                document.getElementById('togglePlay').onclick = function () {
                    sdk.togglePlay();
                };
                document.getElementById('nextTrack').onclick = async function () {
                    sdk.nextTrack().then(() => {
                        console.log('Skipped to next track!');
                    });
                    const state = await sdk.getCurrentState()
                    console.log(state)
                    albumArtUrl = state.track_window.current_track.album.images[2].url
                    console.log(albumArtUrl)
                    resp = await fetch(`/art?url=${albumArtUrl}`, {
                        method: "POST"
                    });

                    console.log(resp)
                };
            }
        })();

    </script>
</body>

</html>